name: Auto Increment Version

on:
  pull_request:
    branches: [ master ]

  workflow_dispatch:

jobs:
  increment:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
        fetch-depth: 0 # otherwise, you will failed to push refs to dest repo

    - name: Get current version
      id: version
      uses: notiz-dev/github-action-json-property@release
      with:
        path: 'config.json'
        prop_path: 'mergeVersion'

    - name: New Version
      id: newVersion
      run: echo "::set-output name=newVersionNumber::$((${{steps.version.outputs.prop}}+1))"

    - name: Get Branch Name
      uses: mdecoleman/pr-branch-name@1.0.1
      id: branchName
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
      
    
    
    - name: Atualizar versao
      uses: jossef/action-set-json-field@v1
      with:
        file: config.json
        field: mergeVersion
        value: ${{ steps.newVersion.outputs.newVersionNumber }}


    - name: Commita as mudancas
      run: |
            git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git commit -m "Auto increment version" -a
            
            
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ steps.branchName.outputs.branch }}
